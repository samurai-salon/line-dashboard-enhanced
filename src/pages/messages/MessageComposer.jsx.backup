import React, { useState, useCallback, useRef, useEffect } from 'react';
import {
  MessageSquare, Send, Plus, Trash2, Bold, Italic, Underline,
  AlignLeft, AlignCenter, AlignRight, Layout, Sparkles, Users, 
  User, UserCheck, CheckSquare, Square, Eye, Calendar
} from 'lucide-react';

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const ChatHistoryPanel = ({ user, messages, onSendReply, newMessage, setNewMessage }) => {
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      onSendReply(user.id);
    }
  };

  return (
    <div className="bg-white/70 backdrop-blur-xl rounded-2xl shadow-lg shadow-black/5 border border-white/20 h-full flex flex-col">
      {/* ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="p-4 border-b border-gray-200 bg-white/80 rounded-t-2xl">
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
            <User className="h-5 w-5 text-white" />
          </div>
          <div>
            <h3 className="font-semibold text-gray-900">{user.name}</h3>
            <p className="text-sm text-gray-500 flex items-center">
              <span className={`inline-block w-2 h-2 rounded-full mr-2 ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'}`}></span>
              {user.isOnline ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : user.lastActive}
            </p>
          </div>
        </div>
      </div>

      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ */}
      <div className="flex-1 p-4 space-y-4 overflow-y-auto max-h-96">
        {messages.map((message) => (
          <div key={message.id} className={`flex ${message.sender === 'official' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
              message.sender === 'official'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 text-gray-900'
            }`}>
              <p className="text-sm">{message.message}</p>
              <div className={`text-xs mt-1 ${
                message.sender === 'official' ? 'text-blue-100' : 'text-gray-500'
              }`}>
                {message.timestamp}
                {message.sender === 'official' && (
                  <span className="ml-2">{message.isRead ? 'æ—¢èª­' : 'æœªèª­'}</span>
                )}
              </div>
            </div>
          </div>
        ))}
        <div ref={messagesEndRef} />
      </div>

      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› */}
      <div className="p-4 border-t border-gray-200 bg-white/80 rounded-b-2xl">
        <div className="flex space-x-2">
          <textarea
            value={newMessage}
            onChange={(e) => setNewMessage(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            rows={2}
          />
          <button
            onClick={() => onSendReply(user.id)}
            disabled={!newMessage.trim()}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
          >
            <Send className="h-4 w-4" />
          </button>
        </div>
      </div>
    </div>
  );
};

const MessageComposer = () => {
  const [messageData, setMessageData] = useState({
    type: 'text',
    content: '',
    quickReply: [],
    actions: []
  });

  const [textFormat, setTextFormat] = useState({
    bold: false,
    italic: false,
    underline: false,
    align: 'left',
    color: '#000000'
  });

  // å—ä¿¡è€…é¸æŠé–¢é€£ã®çŠ¶æ…‹
  const [selectedRecipients, setSelectedRecipients] = useState([]);
  const [selectedOfficialLine, setSelectedOfficialLine] = useState(null);
  const [recipientType, setRecipientType] = useState('individual'); // individual, group, broadcast
  const [showRecipientSelector, setShowRecipientSelector] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');

  // ãƒ‡ãƒ¢ç”¨ã®å…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
  const [officialLines] = useState([
    { id: 1, name: 'ã‚«ãƒ•ã‚§å±±ç”°', displayName: '@cafe_yamada', followers: 1250 },
    { id: 2, name: 'ç¾å®¹å®¤ã‚µã‚¯ãƒ©', displayName: '@sakura_beauty', followers: 890 },
    { id: 3, name: 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¸ãƒ ', displayName: '@fitness_gym', followers: 2100 }
  ]);

  // ãƒ‡ãƒ¢ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
  const [users] = useState([
    { id: 1, name: 'ç”°ä¸­å¤ªéƒ', displayName: 'Taro', avatar: '', lastActive: '2æ™‚é–“å‰', isOnline: true },
    { id: 2, name: 'ä½è—¤èŠ±å­', displayName: 'Hanako', avatar: '', lastActive: '1æ—¥å‰', isOnline: false },
    { id: 3, name: 'å±±ç”°æ¬¡éƒ', displayName: 'Jiro', avatar: '', lastActive: '3æ™‚é–“å‰', isOnline: true },
    { id: 4, name: 'éˆ´æœ¨ç¾å’²', displayName: 'Misaki', avatar: '', lastActive: '30åˆ†å‰', isOnline: true },
    { id: 5, name: 'é«˜æ©‹å¥ä¸€', displayName: 'Kenichi', avatar: '', lastActive: '2æ—¥å‰', isOnline: false }
  ]);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
  const filteredUsers = users.filter(user => 
    user.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    user.displayName.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // ãƒãƒ£ãƒƒãƒˆå±¥æ­´é–¢é€£ã®çŠ¶æ…‹
  const [showChatHistory, setShowChatHistory] = useState(false);
  const [chatHistory, setChatHistory] = useState({});
  const [newMessage, setNewMessage] = useState('');

  // ãƒ‡ãƒ¢ç”¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿
  const generateChatHistory = (userId) => {
    if (!chatHistory[userId]) {
      const histories = {
        1: [ // ç”°ä¸­å¤ªéƒ
          { id: 1, sender: 'user', message: 'ã“ã‚“ã«ã¡ã¯ï¼æ–°å•†å“ã®ä»¶ã§è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚', timestamp: '2æ™‚é–“å‰', isRead: true },
          { id: 2, sender: 'official', message: 'ã“ã‚“ã«ã¡ã¯ã€ç”°ä¸­æ§˜ã€‚ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã©ã®ã‚ˆã†ãªå†…å®¹ã§ã—ã‚‡ã†ã‹ï¼Ÿ', timestamp: '1æ™‚é–“58åˆ†å‰', isRead: true },
          { id: 3, sender: 'user', message: 'ä¾¡æ ¼ã¨é…é€ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„', timestamp: '1æ™‚é–“55åˆ†å‰', isRead: true },
          { id: 4, sender: 'official', message: 'ä¾¡æ ¼ã¯ï¿¥2,980ã§ã€å…¨å›½é€æ–™ç„¡æ–™ã§ã™ã€‚é…é€ã¯é€šå¸¸2-3å–¶æ¥­æ—¥ã¨ãªã‚Šã¾ã™ã€‚', timestamp: '1æ™‚é–“50åˆ†å‰', isRead: true }
        ],
        2: [ // ä½è—¤èŠ±å­
          { id: 1, sender: 'user', message: 'äºˆç´„ã®å¤‰æ›´ã‚’ãŠé¡˜ã„ã—ã¾ã™', timestamp: '1æ—¥å‰', isRead: true },
          { id: 2, sender: 'official', message: 'ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚ã©ã¡ã‚‰ã®æ—¥ç¨‹ã«å¤‰æ›´ã‚’ã”å¸Œæœ›ã§ã—ã‚‡ã†ã‹ï¼Ÿ', timestamp: '23æ™‚é–“å‰', isRead: true },
          { id: 3, sender: 'user', message: 'æ¥é€±ã®ç«æ›œæ—¥ã¯ç©ºã„ã¦ã„ã¾ã™ã‹ï¼Ÿ', timestamp: '22æ™‚é–“å‰', isRead: false }
        ],
        3: [ // å±±ç”°æ¬¡éƒ
          { id: 1, sender: 'user', message: 'å•†å“ãŒå±Šãã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ˜Š', timestamp: '3æ™‚é–“å‰', isRead: true },
          { id: 2, sender: 'official', message: 'ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼æ°—ã«å…¥ã£ã¦ã„ãŸã ã‘ã¦å¬‰ã—ã„ã§ã™ã€‚', timestamp: '2æ™‚é–“45åˆ†å‰', isRead: true }
        ],
        4: [ // éˆ´æœ¨ç¾å’²
          { id: 1, sender: 'user', message: 'ã‚µã‚¤ã‚ºäº¤æ›ã¯å¯èƒ½ã§ã™ã‹ï¼Ÿ', timestamp: '30åˆ†å‰', isRead: false }
        ],
        5: [ // é«˜æ©‹å¥ä¸€
          { id: 1, sender: 'user', message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„', timestamp: '2æ—¥å‰', isRead: true },
          { id: 2, sender: 'official', message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®è©³ç´°ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚', timestamp: '2æ—¥å‰', isRead: true },
          { id: 3, sender: 'user', message: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼', timestamp: '2æ—¥å‰', isRead: true }
        ]
      };
      return histories[userId] || [];
    }
    return chatHistory[userId];
  };

  // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  const addMessageToHistory = (userId, message, sender = 'official') => {
    const newMsg = {
      id: Date.now(),
      sender,
      message,
      timestamp: 'ä»Š',
      isRead: sender === 'official'
    };
    
    setChatHistory(prev => ({
      ...prev,
      [userId]: [...(prev[userId] || generateChatHistory(userId)), newMsg]
    }));
  };

  // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹å•é¡Œè§£æ±ºç‰ˆï¼‰
  const handleTextChange = useCallback((e) => {
    setMessageData(prev => ({ ...prev, content: e.target.value }));
  }, []);

  // å—ä¿¡è€…é¸æŠé–¢é€£ã®é–¢æ•°
  const toggleRecipient = (user) => {
    setSelectedRecipients(prev => {
      const isSelected = prev.find(r => r.id === user.id);
      if (isSelected) {
        return prev.filter(r => r.id !== user.id);
      } else {
        return [...prev, user];
      }
    });
  };

  const selectAllUsers = () => {
    if (selectedRecipients.length === filteredUsers.length) {
      setSelectedRecipients([]);
    } else {
      setSelectedRecipients(filteredUsers);
    }
  };

  const sendMessage = () => {
    if (!messageData.content.trim()) {
      alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!selectedOfficialLine) {
      alert('é€ä¿¡å…ƒã®å…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (recipientType === 'individual' && selectedRecipients.length === 0) {
      alert('é€ä¿¡å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const messageInfo = {
      from: selectedOfficialLine,
      to: recipientType === 'broadcast' ? 'å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼' : selectedRecipients,
      type: recipientType,
      content: messageData.content,
      quickReply: messageData.quickReply,
      timestamp: new Date()
    };

    console.log('Sending message:', messageInfo);

    // å€‹åˆ¥é€ä¿¡ã®å ´åˆã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
    if (recipientType === 'individual') {
      selectedRecipients.forEach(recipient => {
        addMessageToHistory(recipient.id, messageData.content, 'official');
      });
    }
    
    alert(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\né€ä¿¡å…ˆ: ${recipientType === 'broadcast' ? 'å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼' : selectedRecipients.length + 'äºº'}`);
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®ã¿ãƒªã‚»ãƒƒãƒˆï¼ˆå—ä¿¡è€…é¸æŠã¯ä¿æŒï¼‰
    setMessageData({ type: 'text', content: '', quickReply: [], actions: [] });
  };

  // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  const toggleChatHistory = () => {
    if (selectedRecipients.length === 1) {
      setShowChatHistory(!showChatHistory);
    } else if (selectedRecipients.length > 1) {
      alert('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¯1äººé¸æŠæ™‚ã®ã¿è¡¨ç¤ºã§ãã¾ã™');
    } else {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
  };

  // ãƒãƒ£ãƒƒãƒˆã‹ã‚‰ç›´æ¥è¿”ä¿¡
  const sendDirectReply = (userId) => {
    if (!newMessage.trim()) return;
    
    addMessageToHistory(userId, newMessage, 'official');
    setNewMessage('');
  };

  return (
    <div className="h-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex flex-col">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-white/90 backdrop-blur-xl border-b border-gray-200/50 p-6 shadow-sm">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg">
              <MessageSquare className="h-5 w-5 text-white" />
            </div>
            <h1 className="text-2xl font-bold text-gray-900">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h1>
          </div>
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="flex-1 p-6">
        <div className="max-w-7xl mx-auto">
          <div className={`grid gap-6 transition-all duration-300 ${showChatHistory && selectedRecipients.length === 1 ? 'grid-cols-1 lg:grid-cols-3' : 'grid-cols-1'}`}>
            
            {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ‘ãƒãƒ« */}
            <div className={`${showChatHistory && selectedRecipients.length === 1 ? 'lg:col-span-2' : 'max-w-4xl mx-auto'}`}>
              <div className="bg-white/70 backdrop-blur-xl rounded-2xl shadow-lg shadow-black/5 border border-white/20 p-8">
            
            {/* é€ä¿¡å…ƒé¸æŠ */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                é€ä¿¡å…ƒå…¬å¼LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
              </label>
              <select
                value={selectedOfficialLine?.id || ''}
                onChange={(e) => {
                  const line = officialLines.find(l => l.id === parseInt(e.target.value));
                  setSelectedOfficialLine(line || null);
                }}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">é€ä¿¡å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                {officialLines.map(line => (
                  <option key={line.id} value={line.id}>
                    {line.name} ({line.displayName})
                  </option>
                ))}
              </select>
            </div>

            {/* é€ä¿¡ã‚¿ã‚¤ãƒ—é¸æŠ */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                é€ä¿¡æ–¹æ³•
              </label>
              <div className="flex space-x-4">
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="recipientType"
                    value="individual"
                    checked={recipientType === 'individual'}
                    onChange={(e) => setRecipientType(e.target.value)}
                    className="mr-2"
                  />
                  <User className="h-4 w-4 mr-1" />
                  å€‹åˆ¥é€ä¿¡
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="recipientType"
                    value="broadcast"
                    checked={recipientType === 'broadcast'}
                    onChange={(e) => setRecipientType(e.target.value)}
                    className="mr-2"
                  />
                  <Users className="h-4 w-4 mr-1" />
                  ä¸€æ–‰é€ä¿¡
                </label>
              </div>
            </div>

            {/* é€ä¿¡å…ˆé¸æŠ */}
            {recipientType === 'individual' && (
              <div className="mb-6">
                <div className="flex items-center justify-between mb-2">
                  <label className="block text-sm font-medium text-gray-700">
                    é€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ ({selectedRecipients.length}äººé¸æŠä¸­)
                  </label>
                  <button
                    onClick={() => setShowRecipientSelector(!showRecipientSelector)}
                    className="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    {showRecipientSelector ? 'é–‰ã˜ã‚‹' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ'}
                  </button>
                </div>
                
                {/* é¸æŠæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º */}
                {selectedRecipients.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-2">
                    {selectedRecipients.map(user => (
                      <span
                        key={user.id}
                        className="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full"
                      >
                        {user.name}
                        <button
                          onClick={() => toggleRecipient(user)}
                          className="ml-2 hover:text-blue-600"
                        >
                          Ã—
                        </button>
                      </span>
                    ))}
                  </div>
                )}

                {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‘ãƒãƒ« */}
                {showRecipientSelector && (
                  <div className="border border-gray-200 rounded-xl p-4 bg-gray-50 max-h-64 overflow-y-auto">
                    <div className="flex items-center justify-between mb-3">
                      <input
                        type="text"
                        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm mr-3"
                      />
                      <button
                        onClick={selectAllUsers}
                        className="px-3 py-2 text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                      >
                        {selectedRecipients.length === filteredUsers.length ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ'}
                      </button>
                    </div>
                    
                    <div className="space-y-2">
                      {filteredUsers.map(user => {
                        const isSelected = selectedRecipients.find(r => r.id === user.id);
                        return (
                          <div
                            key={user.id}
                            onClick={() => toggleRecipient(user)}
                            className={`flex items-center p-2 rounded-lg cursor-pointer transition-colors ${
                              isSelected ? 'bg-blue-100 text-blue-900' : 'hover:bg-white'
                            }`}
                          >
                            {isSelected ? (
                              <CheckSquare className="h-4 w-4 mr-3 text-blue-600" />
                            ) : (
                              <Square className="h-4 w-4 mr-3 text-gray-400" />
                            )}
                            <div className="flex-1">
                              <div className="font-medium text-sm">{user.name}</div>
                              <div className="text-xs text-gray-500">
                                {user.displayName} â€¢ {user.lastActive}
                                {user.isOnline && (
                                  <span className="ml-2 inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            )}

            {recipientType === 'broadcast' && (
              <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                <div className="flex items-center">
                  <Users className="h-5 w-5 text-yellow-600 mr-2" />
                  <span className="text-sm font-medium text-yellow-800">
                    ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ{selectedOfficialLine?.followers || 0}äººï¼‰ã«ä¸€æ–‰é€ä¿¡ã•ã‚Œã¾ã™
                  </span>
                </div>
              </div>
            )}

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
              </label>

              {/* ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */}
              <div className="mb-2 flex items-center space-x-2 p-2 bg-gray-50 rounded">
                <button
                  type="button"
                  onClick={() => setTextFormat(prev => ({ ...prev, bold: !prev.bold }))}
                  className={`p-2 rounded transition-colors ${textFormat.bold ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-200'}`}
                >
                  <Bold className="h-4 w-4" />
                </button>
                <button
                  type="button"
                  onClick={() => setTextFormat(prev => ({ ...prev, italic: !prev.italic }))}
                  className={`p-2 rounded transition-colors ${textFormat.italic ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-200'}`}
                >
                  <Italic className="h-4 w-4" />
                </button>
                <button
                  type="button"
                  onClick={() => setTextFormat(prev => ({ ...prev, underline: !prev.underline }))}
                  className={`p-2 rounded transition-colors ${textFormat.underline ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-200'}`}
                >
                  <Underline className="h-4 w-4" />
                </button>
                <div className="w-px h-6 bg-gray-300"></div>
                <button
                  type="button"
                  onClick={() => setTextFormat(prev => ({ ...prev, align: 'left' }))}
                  className={`p-2 rounded transition-colors ${textFormat.align === 'left' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-200'}`}
                >
                  <AlignLeft className="h-4 w-4" />
                </button>
                <button
                  type="button"
                  onClick={() => setTextFormat(prev => ({ ...prev, align: 'center' }))}
                  className={`p-2 rounded transition-colors ${textFormat.align === 'center' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-200'}`}
                >
                  <AlignCenter className="h-4 w-4" />
                </button>
                <button
                  type="button"
                  onClick={() => setTextFormat(prev => ({ ...prev, align: 'right' }))}
                  className={`p-2 rounded transition-colors ${textFormat.align === 'right' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-200'}`}
                >
                  <AlignRight className="h-4 w-4" />
                </button>
              </div>

              {/* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ - ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å•é¡Œè§£æ±ºç‰ˆ */}
              <textarea
                value={messageData.content}
                onChange={handleTextChange}
                placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                className="w-full h-32 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                style={{
                  fontWeight: textFormat.bold ? 'bold' : 'normal',
                  fontStyle: textFormat.italic ? 'italic' : 'normal',
                  textDecoration: textFormat.underline ? 'underline' : 'none',
                  textAlign: textFormat.align,
                  color: textFormat.color
                }}
              />
            </div>

            {/* ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤è¨­å®š */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤
              </label>
              <div className="space-y-2">
                {messageData.quickReply.map((reply, index) => (
                  <div key={index} className="flex items-center space-x-2">
                    <input
                      type="text"
                      value={reply.label || ''}
                      onChange={(e) => {
                        const newQuickReply = [...messageData.quickReply];
                        newQuickReply[index] = { ...reply, label: e.target.value };
                        setMessageData(prev => ({ ...prev, quickReply: newQuickReply }));
                      }}
                      className="flex-1 p-2 border border-gray-300 rounded-md"
                      placeholder="ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã®ãƒ†ã‚­ã‚¹ãƒˆ"
                    />
                    <button
                      type="button"
                      onClick={() => {
                        const newQuickReply = messageData.quickReply.filter((_, i) => i !== index);
                        setMessageData(prev => ({ ...prev, quickReply: newQuickReply }));
                      }}
                      className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                    >
                      <Trash2 className="h-4 w-4" />
                    </button>
                  </div>
                ))}
                <button
                  type="button"
                  onClick={() => {
                    const newQuickReply = [...messageData.quickReply, { label: '', value: '', type: 'text' }];
                    setMessageData(prev => ({ ...prev, quickReply: newQuickReply }));
                  }}
                  className="w-full p-2 border-2 border-dashed border-gray-300 rounded-md text-gray-600 hover:border-gray-400 hover:text-gray-800 flex items-center justify-center space-x-2 transition-colors"
                >
                  <Plus className="h-4 w-4" />
                  <span className="text-sm">ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ã‚’è¿½åŠ </span>
                </button>
              </div>
            </div>

            {/* é€ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é€ä¿¡ãƒœã‚¿ãƒ³ */}
            <div className="space-y-4">
              {/* é€ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
              {(selectedOfficialLine || selectedRecipients.length > 0 || recipientType === 'broadcast') && (
                <div className="p-4 bg-gray-50 border border-gray-200 rounded-xl">
                  <h4 className="text-sm font-medium text-gray-700 mb-2">é€ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                  <div className="text-sm space-y-1">
                    <div>
                      <span className="font-medium">é€ä¿¡å…ƒ:</span>{' '}
                      {selectedOfficialLine ? selectedOfficialLine.name : 'æœªé¸æŠ'}
                    </div>
                    <div>
                      <span className="font-medium">é€ä¿¡å…ˆ:</span>{' '}
                      {recipientType === 'broadcast' 
                        ? `å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ${selectedOfficialLine?.followers || 0}äººï¼‰`
                        : `å€‹åˆ¥é€ä¿¡ï¼ˆ${selectedRecipients.length}äººé¸æŠä¸­ï¼‰`
                      }
                    </div>
                    {selectedRecipients.length > 0 && recipientType === 'individual' && (
                      <div className="text-xs text-gray-500 mt-1">
                        {selectedRecipients.map(r => r.name).join(', ')}
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              {/* é€ä¿¡ãƒœã‚¿ãƒ³ */}
              <div className="flex justify-between items-center">
                <div className="flex space-x-2">
                  <button
                    onClick={() => setShowRecipientSelector(!showRecipientSelector)}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 flex items-center space-x-2 transition-colors"
                  >
                    <Eye className="h-4 w-4" />
                    <span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                  </button>
                  
                  <button
                    onClick={toggleChatHistory}
                    disabled={recipientType !== 'individual'}
                    className={`px-4 py-2 border rounded-xl flex items-center space-x-2 transition-colors ${
                      showChatHistory 
                        ? 'bg-green-100 border-green-300 text-green-700' 
                        : 'border-gray-300 text-gray-700 hover:bg-gray-50'
                    } ${recipientType !== 'individual' ? 'opacity-50 cursor-not-allowed' : ''}`}
                  >
                    <MessageSquare className="h-4 w-4" />
                    <span>ãƒãƒ£ãƒƒãƒˆå±¥æ­´</span>
                  </button>
                </div>
                
                <button
                  onClick={sendMessage}
                  disabled={!messageData.content.trim() || !selectedOfficialLine || (recipientType === 'individual' && selectedRecipients.length === 0)}
                  className="px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2 transition-colors"
                >
                  <Send className="h-4 w-4" />
                  <span>é€ä¿¡</span>
                </button>
              </div>
            </div>
            </div>
            
            {/* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ‘ãƒãƒ« */}
            {showChatHistory && selectedRecipients.length === 1 && (
              <div className="lg:col-span-1">
                <ChatHistoryPanel 
                  user={selectedRecipients[0]}
                  messages={chatHistory[selectedRecipients[0].id] || generateChatHistory(selectedRecipients[0].id)}
                  onSendReply={sendDirectReply}
                  newMessage={newMessage}
                  setNewMessage={setNewMessage}
                />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default MessageComposer;